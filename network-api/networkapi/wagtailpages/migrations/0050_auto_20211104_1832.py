# Generated by Django 3.1.11 on 2021-11-04 18:32

from django.db import migrations, models
import django.db.models.deletion
import uuid

cache = {
    'Petition': [],
    'Signup': [],
    'Callpower': [],
}

model_names = list(cache.keys())


def cache_original_CTAs(apps, schema_editor):
    for model_name in model_names:
        Model = apps.get_model("wagtailpages", model_name)
        cache[model_name] = [
            (d.cta_ptr_id, d.locale_id, d.translation_key,) for d in Model.objects.all()
        ]


def copy_cached_values(apps, schema_editor):
    CTA = apps.get_model("wagtailpages", "CTA")

    for model_name in model_names:
        for data in cache[model_name]:
            (cta_ptr_id, locale_id, translation_key) = data
            cta = CTA.objects.get(pk=cta_ptr_id)
            cta.locale_id = locale_id
            cta.translation_key = translation_key
            cta.save()


class Migration(migrations.Migration):

    dependencies = [
        ('wagtailcore', '0062_comment_models_and_pagesubscription'),
        ('wagtailpages', '0049_auto_20211101_1811'),
    ]

    operations = [
        # First, cache all the data we need to carry over
        migrations.RunPython(
            code=cache_original_CTAs
        ),

        # Then rip out the translation fields from the subclasses
        migrations.AlterUniqueTogether(
            name='callpower',
            unique_together=set(),
        ),
        migrations.AlterUniqueTogether(
            name='petition',
            unique_together=set(),
        ),
        migrations.AlterUniqueTogether(
            name='signup',
            unique_together=set(),
        ),
        migrations.RemoveField(
            model_name='callpower',
            name='locale',
        ),
        migrations.RemoveField(
            model_name='callpower',
            name='translation_key',
        ),
        migrations.RemoveField(
            model_name='petition',
            name='locale',
        ),
        migrations.RemoveField(
            model_name='petition',
            name='translation_key',
        ),
        migrations.RemoveField(
            model_name='signup',
            name='locale',
        ),
        migrations.RemoveField(
            model_name='signup',
            name='translation_key',
        ),

        # Then, set up the CTA base class to support those fields instead.
        migrations.AddField(
            model_name='cta',
            name='locale',
            field=models.ForeignKey(default=1, editable=False, on_delete=django.db.models.deletion.PROTECT, related_name='+', to='wagtailcore.locale'),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='cta',
            name='translation_key',
            field=models.UUIDField(null=True),
        ),
        migrations.AlterUniqueTogether(
            name='cta',
            unique_together={('translation_key', 'locale')},
        ),

        # And finally, copy over the cached values that we just performed surgery on
        migrations.RunPython(
            code=copy_cached_values
        ),

        # And then update the translation_key so it has a default
        migrations.AlterField(
            model_name='cta',
            name='translation_key',
            field=models.UUIDField(default=uuid.uuid4, null=False, editable=False),
        ),
    ]
